<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Grana - Conte√∫dos Financeiros</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="css/categorias.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body>
    <header>
        <div class="navbar" id="navbar">
            <div class="logo">
                <a href="index.html">
                    <img src="img/imgs-bernardo/logomelhorada.png" alt="Logo Grana" id="logo" />
                </a>
            </div>
            <div class="links" id="links">
                <ul class="pages">
                    <li class="home"><a href="../index.html">Home</a></li>
                    <li class="noticias"><a href="categorias.html" data-categoria="noticias">Not√≠cias</a></li>
                    <li class="educacao"><a href="categorias.html" data-categoria="educacao">Educa√ß√£o</a></li>
                    <li class="investimentos"><a href="categorias.html" data-categoria="investimento">Investimentos</a>
                    </li>
                </ul>
            </div>
            <i class="fas fa-bars" onclick="toggleMenu()"></i>
        </div>
    </header>

    <div class="app-container">
        <div class="categorias-coluna">
            <h2>Categorias</h2>
            <ul class="lista-categorias" id="listaCategorias">
            </ul>
        </div>
        <div class="conteudos-coluna">
            <h1>Pesquisar</h1>
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Digite o nome do conte√∫do">
                <button id="searchBtn">üîç</button>
            </div>

            <h2 id="titulo-categoria-selecionada">Todos os Conte√∫dos</h2>
            <div id="resultados-conteudo">
            </div>
        </div>
    </div>

    <footer class="rodape">
        <div class="logotipo">
            <img src="img/imgs-bernardo/logomelhorada.png" alt="Logo Grana Footer" />
        </div>
        <div class="containerborder">
            <p>A +Grana te ajuda a cuidar melhor do seu patrim√¥nio, vem aprender com a gente!</p>
            <div class="redes-sociais">
                <a href="#"><i class="fab fa-instagram"></i> +Grana</a>
                <a href="#"><i class="fab fa-linkedin"></i> +Grana</a>
            </div>
        </div>
    </footer>

    <script>
        let dadosExternos;
        let conteudos = [];

        // --- Fun√ß√µes JavaScript ---

        function formatarNomeCategoria(categoria) {
            if (categoria === 'noticias') {
                return 'Not√≠cias';
            }
            return categoria.charAt(0).toUpperCase() + categoria.slice(1);
        }

        function carregarConteudos(categoria = null) {
            const resultadosDiv = document.getElementById("resultados-conteudo");
            const tituloCategoria = document.getElementById("titulo-categoria-selecionada");

            let conteudosFiltrados = conteudos;
            if (categoria && categoria !== "todos") {
                conteudosFiltrados = conteudos.filter(item => item.categoria === categoria);
            }

            tituloCategoria.textContent = (categoria && categoria !== "todos")
                ? `Conte√∫dos: ${formatarNomeCategoria(categoria)}`
                : "Todos os Conte√∫dos";

            resultadosDiv.innerHTML = "";

            if (conteudosFiltrados.length === 0) {
                resultadosDiv.innerHTML = "<p>Nenhum conte√∫do encontrado nesta categoria.</p>";
                return;
            }

            conteudosFiltrados.forEach(item => {
                const card = document.createElement("div");
                card.className = "card-conteudo";
                card.innerHTML = `
                    <h3>${item.titulo}</h3>
                    <p>${item.descricao}</p>
                    <small>Categoria: ${formatarNomeCategoria(item.categoria)}</small>
                    ${item.banner ? `<img src="${item.banner.startsWith('img/') ? '../' + item.banner : item.banner}" alt="${item.descricao}" style="max-width: 100%; height: auto; margin-top: 10px; border-radius: 4px;">` : ''}
                    <button onclick="mostrarDetalhes(${item.id}, '${item.categoria}')">Ler mais</button>
                `;
                resultadosDiv.appendChild(card);
            });
        }

        function mostrarDetalhes(id, categoriaOriginal) {
            const conteudo = conteudos.find(c => c.id == id && c.categoria == categoriaOriginal);
            const resultadosDiv = document.getElementById("resultados-conteudo");

            if (!conteudo) {
                resultadosDiv.innerHTML = "<p>Conte√∫do n√£o encontrado.</p>";
                return;
            }

            resultadosDiv.innerHTML = `
                <div class="detalhes-conteudo">
                    <button onclick="voltarParaLista('${categoriaOriginal}')">‚Üê Voltar</button>
                    <h2>${conteudo.titulo}</h2>
                    ${conteudo.banner ? `<img src="${conteudo.banner.startsWith('img/') ? '../' + item.banner : item.banner}" alt="${conteudo.descricao}" style="max-width: 100%; height: auto; margin-bottom: 15px; border-radius: 8px;">` : ''}
                    <div class="conteudo-texto">${conteudo.conteudoCompleto}</div>
                    ${conteudo.autor ? `<p><strong>Autor:</strong> ${conteudo.autor}</p>` : ''}
                    ${conteudo.data ? `<p><strong>Data:</strong> ${conteudo.data}</p>` : ''}
                </div>
            `;
        }

        function voltarParaLista(categoria) {
            document.getElementById("searchInput").value = "";
            carregarConteudos(categoria);
        }

        function carregarCategorias() {
            const listaCategoriasUl = document.getElementById("listaCategorias");
            listaCategoriasUl.innerHTML = '';

            const liTodos = document.createElement("li");
            const linkTodos = document.createElement("a");
            linkTodos.href = "#";
            linkTodos.className = "categoria-link";
            linkTodos.textContent = "Todos os Conte√∫dos";
            linkTodos.dataset.categoria = "todos";
            liTodos.appendChild(linkTodos);
            listaCategoriasUl.appendChild(liTodos);

            const categoriasUnicas = Object.keys(dadosExternos);

            categoriasUnicas.forEach(categoriaChave => {
                const li = document.createElement("li");
                const link = document.createElement("a");
                link.href = "#";
                link.className = "categoria-link";
                link.textContent = formatarNomeCategoria(categoriaChave);
                link.dataset.categoria = categoriaChave;

                li.appendChild(link);
                listaCategoriasUl.appendChild(li);
            });

            document.querySelectorAll('.categoria-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const categoria = e.target.dataset.categoria;
                    document.getElementById("searchInput").value = "";
                    if (categoria === "todos") {
                        carregarConteudos();
                    } else {
                        carregarConteudos(categoria);
                    }
                });
            });
        }

        // Event Listeners para a busca
        document.getElementById("searchBtn").addEventListener("click", function () {
            const termo = document.getElementById("searchInput").value.toLowerCase();
            const tituloCategoria = document.getElementById("titulo-categoria-selecionada");

            if (!termo) {
                carregarConteudos();
                return;
            }

            const resultados = conteudos.filter(item =>
                item.titulo.toLowerCase().includes(termo) ||
                item.descricao.toLowerCase().includes(termo) ||
                item.conteudoCompleto.toLowerCase().includes(termo)
            );

            const resultadosDiv = document.getElementById("resultados-conteudo");
            resultadosDiv.innerHTML = "";

            if (resultados.length === 0) {
                resultadosDiv.innerHTML = "<p>Nenhum resultado encontrado para '" + termo + "'.</p>";
                tituloCategoria.textContent = `Resultados da Busca por: "${termo}"`;
                return;
            }

            tituloCategoria.textContent = `Resultados da Busca por: "${termo}"`;

            resultados.forEach(item => {
                const card = document.createElement("div");
                card.className = "card-conteudo";
                card.innerHTML = `
                    <h3>${item.titulo}</h3>
                    <p>${item.descricao}</p>
                    <small>Categoria: ${formatarNomeCategoria(item.categoria)}</small>
                    ${item.banner ? `<img src="${item.banner.startsWith('img/') ? '../' + item.banner : item.banner}" alt="${item.descricao}" style="max-width: 100%; height: auto; margin-top: 10px; border-radius: 4px;">` : ''}
                    <button onclick="mostrarDetalhes(${item.id}, '${item.categoria}')">Ler mais</button>
                `;
                resultadosDiv.appendChild(card);
            });
        });

        document.getElementById("searchInput").addEventListener("keyup", function (event) {
            if (event.key === "Enter") {
                document.getElementById("searchBtn").click();
            }
        });


        // --- FUN√á√ÉO CR√çTICA: Buscar TODOS os dados do JSON Server por Cole√ß√£o ---
        async function fetchAllDataFromJSONServer() {
            const categoriasDoJSON = ['educacao', 'noticias', 'investimento'];
            const allFetchedData = {};

            for (const categoria of categoriasDoJSON) {
                try {
                    // Esta √© a URL que DEVE apontar para o JSON Server!
                    const response = await fetch(`http://localhost:3000/${categoria}`);
                    if (!response.ok) {
                        console.warn(`Aviso: N√£o foi poss√≠vel carregar a categoria ${categoria} do JSON Server. Status: ${response.status} ${response.statusText}`);
                        continue;
                    }
                    allFetchedData[categoria] = await response.json();
                } catch (error) {
                    console.error(`Erro ao carregar a categoria ${categoria} do JSON Server:`, error);
                }
            }
            return allFetchedData;
        }

        // --- Fun√ß√£o de Inicializa√ß√£o Principal ---
        async function init() {
            try {
                dadosExternos = await fetchAllDataFromJSONServer();

                if (!dadosExternos || Object.keys(dadosExternos).length === 0) {
                    throw new Error("Nenhum dado foi carregado do JSON Server. Verifique o servidor JSON.");
                }

                conteudos = [];
                for (const categoria in dadosExternos) {
                    if (dadosExternos.hasOwnProperty(categoria)) {
                        dadosExternos[categoria].forEach(item => {
                            conteudos.push({
                                id: item.id,
                                titulo: item.titulo,
                                categoria: item.categoria || categoria,
                                descricao: item.resumo || "",
                                conteudoCompleto: item.texto || item.conteudo || "",
                                banner: item.banner || item.imagem || "", // Aqui est√° o problema com caminhos de imagem nos dados
                                autor: item.autor || "",
                                data: item.data || ""
                            });
                        });
                    }
                }

                carregarCategorias();
                carregarConteudos();

            } catch (error) {
                console.error("Erro fatal ao inicializar a p√°gina (JS):", error);
                document.getElementById("resultados-conteudo").innerHTML = "<p>Ocorreu um erro cr√≠tico ao carregar os conte√∫dos. Por favor, verifique se o JSON Server est√° rodando corretamente e se h√° conex√£o.</p>";
            }
        }

        // --- Inicia o processo de carregamento dos dados e a renderiza√ß√£o da p√°gina ---
        init();
    </script>
    <script>
        const menuBtn = document.getElementById("hamburguerMenu");
        const dropdown = document.getElementById("dropdownMenu");

        menuBtn.addEventListener("click", function (e) {
            e.preventDefault();
            dropdown.classList.toggle("esconder");
        });

        // Fecha o dropdown ao clicar fora dele
        window.addEventListener("click", function (e) {
            if (!menuBtn.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add("esconder");
            }
        });
    </script>
    <script src="js/user.js"></script>
</body>

</html>